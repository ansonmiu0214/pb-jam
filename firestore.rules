// Firebase Firestore Security Rules
// This file contains the security rules for Firestore to ensure user-level data isolation
// Supports persistent data access using application user IDs (e.g., Spotify user IDs)

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Allow read/write to user's own data only
    match /users/{userId}/{document=**} {
      // Allow all operations if authenticated (temporary permissive rules for debugging)
      allow read, create, update, delete: if request.auth != null;
    }

    // Default: deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

/*
EXPLANATION:

1. User-Scoped Collections:
   - Path: /users/{userId}/...
   - {userId} is the application user ID (e.g., Spotify user ID, Firebase UID)
   - Only users with matching userId field can read/write

2. Document Structure:
   - /users/{userId}/races/{raceId}
   - /users/{userId}/races/{raceId}/pacePlans/{pacePlanId}
   - /users/{userId}/tests/{testDocId}
   - Each document MUST have a userId field matching the path

3. Security Model:
   - Authentication: User must be logged into Firebase Auth (anonymously or via provider)
   - Authorization: userId field in document must match the path userId
   - This allows persistent data access across login sessions
   - For example, same Spotify user gets same data every time they log in

4. Benefits:
   ✓ Users can only read their own data
   ✓ Users can only write to their own data
   ✓ No user can access another user's data
   ✓ All other collections are denied by default
   ✓ Data persists across login sessions (using stable application user IDs)

5. Example Flow:
   - Spotify user logs in, gets Spotify ID "spotify_123"
   - Creates a race at /users/spotify_123/races/race_1
   - Race document has userId: "spotify_123"
   - Later, same Spotify user logs in again
   - Gets same data because it's stored under same user ID
*/

/*
EXPLANATION:

1. User-Scoped Collections:
   - Path: /users/{userId}/...
   - Only the authenticated user matching {userId} can read/write
   - This ensures complete data isolation between users

2. Document Structure:
   - /users/{userId}/races/{raceId}
   - /users/{userId}/races/{raceId}/pacePlans/{pacePlanId}
   - /users/{userId}/tests/{testDocId}  (for Prompt 3.3 testing)

3. Security Benefits:
   ✓ Users can only read their own data
   ✓ Users can only write to their own data
   ✓ No user can access another user's data
   ✓ All other collections are denied by default

4. Testing:
   - Test documents are created under /users/{userId}/tests
   - Each user's test documents are isolated
   - Useful for verifying Firestore connectivity

5. Future Improvements:
   - Add specific validation rules per collection
   - Add timestamp constraints (createdAt, updatedAt)
   - Add field-level access control if needed
*/
